## CSVファイル・ジョブ運用に扱う決め事

CSV形式でデータ交換を行うジョブの場合、必ず以下の項目の取り決めを行います。特に「文字コードが違う」「改行が含まれている」「データにヘッダが入ってしまった」という失敗をよく聞きます。一方、扱うデータ・ジョブ運用に関する設計もれ・つまづき事例もあります。

### 1. CSVファイルの扱い

- [ ] 文字コード: UTF-8, SJIS,  EUC、ホスト系
- [ ] データレイアウト：書式・値の範囲
- [ ] 改行コード:LF, CRLF,CR
- [ ] ヘッダ行の有無: #, その他
- [ ] 区切り文字: カンマ、タブ、半角スペース
- [ ] ダブルクォートの扱い：必須・不要・どちらでもよい
- [ ] ダブルクォートで囲む場合の制御文字の扱い(ダブルクォート、カンマ、タブ、改行)の扱い
- [ ] ファイルの終端・空行の扱い; EOFコード・改行のみ
- [ ] 0件データの扱い：ヘッダの有無、送信・受信の有無
- [ ] 0バイトファイルの扱い：常時送信・受信の有無
- [ ] 休日・メンテナンス時の送信方法の扱い：翌日送信、前日分・翌日連結の可否、ファイル名

### 2. データの扱い

- [ ] 数値の扱い：型・桁・有効範囲・小数点
- [ ] 文字列の扱い: 固定長・可変長、トリミングの有無、NULL、数値、単位
- [ ] 相関チェックの扱い：合計値（税別・税込み）、値割引、ポイント、大小関係

### 3. ジョブ運用

  - [ ] データ誤りの扱い：全件エラー扱いとするか、スキップ扱いとするか。ロールバック処理や出力メッセージ、スキップしたデータの再送期限
  - [ ] 繁忙期・メンテナンス日の扱い：期限つきスケールアップ・ジョブ並列実行など特定運用とするかどうか。メンテナンス時の縮退範囲はどうなるか
  - [ ] 優先順位付け：業務として必要か不要か。必要ならばジョブ単位に重要度づけが必要
  - [ ] 疎通モードの実装：実行方法・確認方法
  - [ ] ジョブ正常性確認：確認方法（ステータス・店舗別処理数・全体件数・登録数・変更数・削除数
  - [ ] トラブルシュート：切り分け手順（一次・二次）
  - [ ] リラン方法：前手順、後手順、実行手順、コミュニケーション方法・必要情報
  - [ ] 業務日付の扱い：過去日時、現在日時、未来日時のテストの可否
  - [ ] ログファイルの作成：フォルダ・出力先のファイルがない場合の扱い
  - [ ] ログファイル保管期間：日・週・月・年
  - [ ] ローテーション：対象DB、対象ファイル
  - [ ] 正常通知：ログファイルのみ、ログ＋メール・宛先
  - [ ] エラー通知：ログファイルのみ、ログ＋メール・宛先
  - [ ] 警告レベルの通知：ログファイルのみ、ログ＋メール・宛先
  - [ ] 通知ファイル：ログファイルのみ、ログ＋メール・宛先
  - [ ] アクセスキーの更新頻度：ユーザＩＤ・パスワード、API キー
  - [ ] ファイル共有場所：実装モジュール・AP実行場所・ログ・中間ファイル・アクセス方法

### 4. 設定
  - [ ] アクセス設定：アクセスID、パスワード、鍵
  - [ ] アクセスポリシー：Proxyサーバー、ポート番号、ホワイトリスト
  - [ ] ジョブスケジュール：定常運用、例外運用
  - [ ] ログファイル：宛先フォルダ、パーミッション
  - [ ] メール宛先：顧客部門、外部ベンダー、運用部門
  - [ ] 接続DB：更新先、参照先

### 5. 実装方式
 - [ ] 親ジョブ、子ジョブ、共通処理の関係づけ
 - [ ] スケジュールモード、マニュアルモード
 - [ ] 疎通モード、設定確認
 - [ ] 二重起動の抑制
 - [ ] ジョブロック・キャンセル・再開の制御
 - [ ] シグナル処理
 - [ ] ロックファイルの後始末
 - [ ] 処理件数
 - [ ] トランザクション単位
 - [ ] メールログにごみを残さない実装
 - [ ] リターン値のチェック
 - [ ] ハードコーディングをしない工夫：設定外だし
 - [ ] 高負荷・高コストにしない工夫：ループの空回しをしない。ネットワークアクセスのコストを減らす
 - [ ] 安心・安全にする工夫：フェールセーフ・フールプルーフ

<EOF>